<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="static/1.jpeg" type="image/x-icon">
  <title>Evaluaciones - RH</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(-45deg, #0f172a, #0d9488, #1e3a8a, #4f46e5);
      background-size: 400% 400%;
      animation: gradientBG 18s ease infinite;
      min-height: 100vh;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .soft-glow { box-shadow: 0 8px 30px rgba(2,6,23,0.25); }
  </style>
</head>
<body class="p-6 text-gray-800">

  <div class="max-w-6xl mx-auto space-y-8">
    <header class="flex justify-between items-center text-white">
      <div>
        <h1 class="text-3xl font-extrabold">ðŸ“Š Evaluaciones de DesempeÃ±o</h1>
        <p class="text-sm text-gray-200">Usuario: {{ session.get('usuario') }}</p>
      </div>
      <div class="space-x-4">
        <a href="/" class="bg-white text-indigo-700 px-4 py-2 rounded shadow">Volver</a>
        <a href="/logout" class="text-sm text-gray-100 underline">Cerrar sesiÃ³n</a>
      </div>
    </header>

    <!-- Formulario -->
    <section class="bg-white p-6 rounded-xl soft-glow">
      <h2 class="text-xl font-semibold mb-4">Registrar nueva evaluaciÃ³n</h2>
      <form action="/evaluaciones/agregar" method="POST" class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Empleado (nombre o cÃ©dula)</label>
          <input id="empleado_input" name="empleado_input" autocomplete="off" placeholder="Buscar empleado..."
                 class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500">
          <input type="hidden" id="empleado_id" name="empleado_id">
          <div id="suggestions" class="mt-1 bg-white border border-gray-300 rounded hidden"></div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Fecha</label>
          <input type="date" name="fecha" required class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Criterio</label>
          <input name="criterio" required class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Puntaje (1â€“100)</label>
          <input type="number" name="puntaje" min="1" max="100" required class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Resultado</label>
          <input name="resultado" class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Observaciones</label>
          <textarea name="observaciones" rows="2" class="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500"></textarea>
        </div>
        <div class="md:col-span-2 flex justify-end">
          <button class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700">Guardar</button>
        </div>
      </form>
    </section>

    <!-- Tabla -->
    <section class="bg-white p-6 rounded-xl soft-glow">
      <h2 class="text-xl font-semibold mb-4">Historial de Evaluaciones</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto border">
          <thead class="bg-indigo-600 text-white">
            <tr>
              <th class="px-3 py-2 text-left">Empleado</th>
              <th class="px-3 py-2 text-left">Fecha</th>
              <th class="px-3 py-2 text-left">Criterio</th>
              <th class="px-3 py-2 text-left">Puntaje</th>
              <th class="px-3 py-2 text-left">Resultado</th>
              <th class="px-3 py-2 text-left">Observaciones</th>
              {% if session.get('rol') in ['admin'] %}
              <th class="px-3 py-2 text-center">Acciones</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for ev in evaluaciones %}
            <tr class="border-b hover:bg-gray-50">
              <td class="px-3 py-2">{{ ev['nombre'] }}</td>
              <td class="px-3 py-2">{{ ev['fecha'] }}</td>
              <td class="px-3 py-2">{{ ev['criterio'] }}</td>
              <td class="px-3 py-2">{{ ev['puntaje'] }}</td>
              <td class="px-3 py-2">{{ ev['resultado'] or '-' }}</td>
              <td class="px-3 py-2">{{ ev['observaciones'] or '-' }}</td>
              <td class="px-3 py-2 text-center">
                {% if session.get('rol') in ['admin'] %}
                <a href="/evaluaciones/eliminar/{{ ev['id'] }}" class="text-red-600 hover:underline"
                   onclick="return confirm('Â¿Eliminar esta evaluaciÃ³n?')">Eliminar</a>
                   {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center py-3 text-gray-500">No hay evaluaciones registradas.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // Autocompletar empleados
    const input = document.getElementById('empleado_input');
    const suggestions = document.getElementById('suggestions');
    const hiddenId = document.getElementById('empleado_id');
    let timer = null;

    input.addEventListener('input', e => {
      clearTimeout(timer);
      const q = e.target.value.trim();
      hiddenId.value = "";
      suggestions.innerHTML = "";
      suggestions.classList.add('hidden');
      if (!q) return;
      timer = setTimeout(() => {
        fetch(`/empleados/search?q=${encodeURIComponent(q)}`)
          .then(r => r.json())
          .then(data => {
            suggestions.innerHTML = "";
            if (!data.length) return;
            data.forEach(emp => {
              const div = document.createElement('div');
              div.className = "px-3 py-2 hover:bg-indigo-50 cursor-pointer";
              div.innerHTML = `<b>${emp.nombre}</b> <span class='text-sm text-gray-500'>(${emp.cedula})</span>`;
              div.onclick = () => {
                input.value = emp.nombre;
                hiddenId.value = emp.id;
                suggestions.classList.add('hidden');
              };
              suggestions.appendChild(div);
            });
            suggestions.classList.remove('hidden');
          });
      }, 250);
    });
  </script>
</body>
</html>
